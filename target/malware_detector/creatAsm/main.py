__author__ = 'ASUS'
import os, string, shutil,re
import pefile
import traceback
from creatAsm.creatNgramcsv import creatNgramcsv
from creatAsm.getFolderName import getFilename
from creatAsm.extractFeature import extractFeature

def get_opcode_csv(dirPath):
	exeList = getFilename(dirPath)
	root_path = r'E:\malware_detector\web\creatAsm'
	for exeName in exeList:
		root_path = dirPath
		exeName=exeName.split('\\')[-1]
		each_file = os.path.join(root_path, exeName)
		pe = pefile.PE(each_file)
		try:
			os.system('D:\IDA6.8\idaq.exe  -B ' + '"'+each_file+'"')
		except Exception as e:
			error_string = traceback.format_exc()
			with open('error_log.txt', 'w+') as f:
				f.write(each_file + 'gets Wrong! ')
				f.write('ERROE Info: %s \n' % e)
				f.write(error_string + '\n')

		asmName = exeName.split('.')[0] + '.asm'
		idbName = exeName.split('.')[0] + '.idb'
		srcPath = os.path.join(dirPath, asmName)
		desPath = os.path.join('E:\malware_detector\web\creatAsm\\asmFile', asmName)
		delPath = os.path.join(root_path, idbName)
		shutil.move(srcPath, desPath)
		os.unlink(delPath)
		creatNgramcsv(asmName, 'E:\malware_detector\web\creatAsm\\ngramOpcode', 'E:\malware_detector\web\creatAsm\\asmFile')
		extractFeature('E:\malware_detector\web\creatAsm\\halfOpcode.csv','E:\malware_detector\web\creatAsm\\ngramOpcode')
