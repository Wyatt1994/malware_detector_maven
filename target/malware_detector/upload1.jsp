<%@ page language="java" contentType="text/html; charset=UTF-8"
         pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@include file="/include/admin/adminHeader.jsp"%>
<%@include file="/include/admin/adminNavigator.jsp"%>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>文件上传</title>
    <style type="text/css">
        #loading-cover{
            width: 0px;
            height: 0px;
            position: absolute;
            background: rgba(0,0,0,0.0);
            top:0;
            left: 0;
            z-index: 2;
        }
        #showloading{
            width: 300px;
            position: absolute;
            bottom: 0;
            text-align: center;
            z-index: 3;
        }
        #show_process{
            font-family:"微软雅黑 Light";
        }

    </style>
</head>
<body>
<div class="panel panel-warning addDiv">
    <div class="panel-heading">新增上传</div>
    <div class="panel-body">
        <form >
            <table class="addTable">
                <tr>
                    <td>上传文件：</td>
                    <td>
                        <input name="file" type="file" id="file" size="20" />
                    </td>
                </tr>
                <tr>
                    <td colspan="1" align="left">
                        <button onclick="fileSelected()" type="button" class="btn btn-success">文件信息</button>

                    </td>
                    <td colspan="3"align="center">
                        <button onclick="uploadFile()" type="button" id="upload" class="btn btn-success">确认上传</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>


    <div id="info">
        <div id="fileName"></div>
        <div id="fileSize"></div>
        <div id="fileType"></div>
    </div>
    <progress id="progressbar" value="0" max="100" style="width:400px;height:30px;background-color: #F6F5F1;"></progress><span id="percentage"></span>
    <div id="loading-cover"></div>
    <div id="showloading"></div>
    <div class="registerErrorMessageDiv">
        <div class="alert alert-danger" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>
            <span class="errorMessage" id="show_load"></span>
        </div>
    </div>
    <span class="errorMessage" id="show_process"></span>
</div>



<script>
    var fileExist=false;
    $("#show_load").html("允许上传文件格式:exe,jpg,文件大小不超过4M");$("div.registerErrorMessageDiv").show();

    function fileSelected() {
        var file = document.getElementById('file').files[0];
        if (file) {
            var fileSize = 0;
            if (file.size > 1024 * 1024)
                fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
            else
                fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
            document.getElementById('fileName').innerHTML = 'Name: ' + file.name;
            document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
            document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
        }
    }
    function uploadFile() {
        var fd = new FormData();
        var file = document.getElementById('file').files[0];
        if (file)
            fileExist=true;
        fd.append("file", document.getElementById('file').files[0]);
        if(file.size>4*1024*1024){
            alert("上传文件不能超过4M");
            return false;
        }
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener("progress", uploadProgress, false);
        xhr.addEventListener("load", uploadComplete, false);
        xhr.addEventListener("error", uploadFailed, false);
        xhr.addEventListener("abort", uploadCanceled, false);
        xhr.open("POST", "/malware_detector/UploadServlet");//修改成自己的接口
        xhr.send(fd);
    }

    function uploadProgress(evt) {
        if(fileExist){
            var loadingCover = document.getElementById('loading-cover');
            var showloading = document.getElementById('showloading');
            var progressBar = document.getElementById('progressbar');
            var percentage = document.getElementById('percentage');
            if(evt.lengthComputable){
                progressbar.max = evt.total;
                progressBar.value = evt.loaded;
                var loading = Math.round(evt.loaded / evt.total * 100);
                percentage.innerHTML = loading + '%';
                showloading.innerHTML = loading + '%';
                loadingCover.style.top = -loading + '%';
                if(loading==100){
                    showloading.style.display = 'none';
                }
            }
        }
    }
    function uploadComplete(evt) {
        /* 服务器端返回响应时候触发event事件*/
//        document.getElementById('result').innerHTML = evt.target.responseText;
        $("#show_load").html( evt.target.responseText+"<br/>");$("div.registerErrorMessageDiv").show();

        getMsgNum();



    }
    function uploadFailed(evt) {
        alert("There was an error attempting to upload the file.");
    }
    function uploadCanceled(evt) {
        alert("The upload has been canceled by the user or the browser dropped the connection.");
    }


    function getMsgNum() {
        $.ajax({
            url: '/malware_detector/UploadServlet',
            type: 'get',
            data: {"msg": $("#show_process").val()},
            timeout: 5000,
            success: function (data, textStatus) {
                if (data) {
                    if(data.indexOf("predict")==-1)
                    {
                        //请求成功，刷新数据
                        $("#show_process").html(data+"<img src='img/loading2.gif' align='center' width='30px' height='30px'> ");
                        //这个是用来和后台数据作对比判断是否发生了改变
                        //$("#pageMsgNum").val(data);
                    }
                    else {
                        $("#show_process").html(data);
                        return;
                    }

                }

                if (textStatus == "success") {
                    //成功之后，再发送请求，递归调用
                    getMsgNum();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                if (textStatus == "timeout") {
                    //有效时间内没有响应，请求超时，重新发请求
                    getMsgNum();
                } else {
                    // 其他的错误，如网络错误等
                    alert("网络错误")
                }
            }
        });
    }



</script>

</body>
</html>